<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoKids</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 min-h-screen font-['Poppins']">
    <div id="name-input" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl font-bold mb-4">Voer je naam in</h2>
            <input type="text" id="player-name" class="border-2 border-purple-300 rounded-full px-3 py-1 w-full focus:outline-none focus:border-purple-500 mb-4">
            <button id="submit-name" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 w-full">
                Start
            </button>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <h1 class="text-4xl font-bold text-center text-white mb-6 shadow-lg">PictoKids</h1>
        
        <div id="main-menu" class="text-center space-y-4 hidden">
            <button id="local-game" class="bg-yellow-400 hover:bg-yellow-500 text-purple-800 font-bold py-2 px-4 rounded-full text-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg w-full max-w-md">
                Speel Lokaal
            </button>
            <button id="online-game" class="bg-green-400 hover:bg-green-500 text-purple-800 font-bold py-2 px-4 rounded-full text-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg w-full max-w-md">
                Speel Online
            </button>
        </div>

        <div id="lobby" class="hidden mt-6 bg-white rounded-lg shadow-2xl p-4">
            <h2 class="text-2xl font-bold text-center text-purple-800 mb-4">Lobby</h2>
            <div id="tables" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Table elements will be dynamically added here -->
            </div>
        </div>

        <div id="game-area" class="hidden mt-6 bg-white rounded-lg shadow-2xl p-4">
            <div class="flex justify-between mb-4 text-purple-800 text-sm">
                <div id="word-to-draw" class="font-semibold"></div>
                <div id="timer" class="w-1/3"></div>
                <div id="score" class="font-semibold"></div>
            </div>
            <div id="opponent-score" class="mb-2 text-purple-800 text-sm"></div>
            
            <div class="flex">
                <div id="canvas-container" class="w-2/3 aspect-[3/4] relative">
                    <canvas id="drawing-board" class="absolute top-0 left-0 w-full h-full border-4 border-purple-500 rounded-lg bg-white touch-none"></canvas>
                </div>
                <div class="w-1/3 pl-4">
                    <div id="color-palette" class="flex flex-wrap justify-center mb-4 space-x-2 space-y-2"></div>
                    <button id="clear-canvas" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 w-full mb-4">
                        Wis tekening
                    </button>
                    <div id="guess-area" class="text-center">
                        <input type="text" id="guess-input" placeholder="Raad het woord" class="border-2 border-purple-300 rounded-full px-3 py-1 w-full focus:outline-none focus:border-purple-500 mb-2">
                        <button id="submit-guess" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-4 rounded-full transition duration-300 ease-in-out transform hover:scale-105 w-full">
                            Raad
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="feedback" class="mt-4 text-center font-bold text-lg text-purple-600"></div>
        </div>
    </div>

    <script>
                console.log("Script is loaded");

        // Game variables
        let currentWord, timeLeft, score, currentPlayer, gameMode, currentTable;
        let playerName, opponentName;
        let timerBar;
        const words = ['kat', 'hond', 'boom', 'huis', 'zon', 'bloem', 'auto', 'vliegtuig', 'vis', 'vogel'];
        const colors = ['#000000', '#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];

        // DOM elements
        const mainMenu = document.getElementById('main-menu');
        const lobby = document.getElementById('lobby');
        const tables = document.getElementById('tables');
        const gameArea = document.getElementById('game-area');
        const localGameBtn = document.getElementById('local-game');
        const onlineGameBtn = document.getElementById('online-game');
        const canvas = document.getElementById('drawing-board');
        const ctx = canvas.getContext('2d');
        const guessInput = document.getElementById('guess-input');
        const submitGuessBtn = document.getElementById('submit-guess');
        const wordToDrawElement = document.getElementById('word-to-draw');
        const timerElement = document.getElementById('timer');
        const scoreElement = document.getElementById('score');
        const feedbackElement = document.getElementById('feedback');
        const colorPalette = document.getElementById('color-palette');
        const clearCanvasBtn = document.getElementById('clear-canvas');

        // Drawing variables
        let isDrawing = false;
        let currentColor = '#000000';
        let lastX = 0;
        let lastY = 0;

        // Event listeners
        document.getElementById('submit-name').addEventListener('click', setPlayerName);
        localGameBtn.addEventListener('click', startLocalGame);
        onlineGameBtn.addEventListener('click', showLobby);
        submitGuessBtn.addEventListener('click', submitGuess);
        clearCanvasBtn.addEventListener('click', clearCanvas);

        // Touch events
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('touchmove', handleMove, { passive: false });
        canvas.addEventListener('touchend', handleEnd, { passive: false });

        // Mouse events
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseout', handleEnd);

        // Resize event
        window.addEventListener('resize', resizeCanvas);

        // Socket.io setup
        const socket = io();
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('lobbyUpdate', updateLobby);
        socket.on('gameStart', startOnlineGame);
        socket.on('draw', (data) => drawLine(data.x1, data.y1, data.x2, data.y2, data.color));
        socket.on('clear', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
        socket.on('newRound', startNewRound);
        socket.on('updateScore', updateScore);
        socket.on('updateScores', (scores) => {
            scores.forEach(updateScore);
        });
        socket.on('playerLeft', () => {
            alert('De andere speler heeft het spel verlaten. Je wordt teruggestuurd naar de lobby.');
            showLobby();
        });
        socket.on('nameSet', () => {
            document.getElementById('name-input').classList.add('hidden');
            mainMenu.classList.remove('hidden');
        });

        function setPlayerName() {
            playerName = document.getElementById('player-name').value.trim();
            if (playerName) {
                socket.emit('setName', playerName);
            }
        }

        function showLobby() {
            console.log("Showing lobby");
            mainMenu.classList.add('hidden');
            gameArea.classList.add('hidden');
            lobby.classList.remove('hidden');
            socket.emit('enterLobby');
        }

        function leaveLobby() {
            lobby.classList.add('hidden');
        }

        function updateLobby(lobbyData) {
            console.log("Updating lobby", lobbyData);
            tables.innerHTML = '';
            lobbyData.forEach((table, index) => {
                const tableElement = document.createElement('div');
                tableElement.className = 'table bg-purple-100 p-4 rounded-lg shadow';
                tableElement.innerHTML = `
                    <h3 class="font-bold text-purple-800">Tafel ${index + 1}</h3>
                    <p class="players">${table.players}/2 spelers</p>
                    ${table.playerNames ? `<p class="text-sm">${table.playerNames.join(', ')}</p>` : ''}
                    <button class="join-table bg-green-400 hover:bg-green-500 text-purple-800 font-bold py-1 px-3 rounded-full mt-2">Deelnemen</button>
                `;
                const joinButton = tableElement.querySelector('.join-table');

                if (table.players < 2) {
                    joinButton.onclick = () => joinTable(index);
                } else {
                    joinButton.disabled = true;
                    joinButton.classList.add('opacity-50', 'cursor-not-allowed');
                }

                if (table.players === 1) {
                    tableElement.querySelector('.players').textContent += ' - Wachten op speler';
                }

                tables.appendChild(tableElement);
            });
        }

        function joinTable(tableIndex) {
            console.log("Joining table", tableIndex);
            socket.emit('joinTable', tableIndex);
            currentTable = tableIndex;
            document.querySelectorAll('.join-table').forEach(btn => btn.disabled = true);
        }

        function startLocalGame() {
            console.log("Starting local game");
            gameMode = 'local';
            mainMenu.classList.add('hidden');
            gameArea.classList.remove('hidden');
            initializeGame();
            resizeCanvas();
        }

        function startOnlineGame(gameData) {
            console.log("Starting online game", gameData);
            gameMode = 'online';
            leaveLobby();
            gameArea.classList.remove('hidden');
            currentPlayer = gameData.role;
            opponentName = gameData.opponent;
            initializeGame();
            resizeCanvas();
            socket.emit('getScores', currentTable);
        }

        function initializeGame() {
            score = 0;
            updateScore({ id: socket.id, name: playerName, score: 0 });
            if (gameMode === 'local') {
                nextRound();
            }
        }

        function startNewRound(roundData) {
            currentWord = roundData.word;
            timeLeft = 60;
            updateGameInfo();
            clearCanvas();
            startTimer();
        }

        function nextRound() {
            currentWord = getRandomWord();
            timeLeft = 60;
            updateGameInfo();
            clearCanvas();
            startTimer();
        }

        function getRandomWord() {
            return words[Math.floor(Math.random() * words.length)];
        }

        function updateGameInfo() {
            if (currentPlayer === 'drawer') {
                wordToDrawElement.textContent = `Teken: ${currentWord}`;
                guessInput.classList.add('hidden');
                submitGuessBtn.classList.add('hidden');
                clearCanvasBtn.classList.remove('hidden');
            } else {
                wordToDrawElement.textContent = 'Raad het woord!';
                guessInput.classList.remove('hidden');
                submitGuessBtn.classList.remove('hidden');
                clearCanvasBtn.classList.add('hidden');
            }
        }

        function startTimer() {
            timeLeft = 60;
            timerBar = document.createElement('div');
            timerBar.className = 'h-2 bg-green-500 transition-all duration-1000 ease-linear';
            timerElement.innerHTML = '';
            timerElement.appendChild(timerBar);

            const timerInterval = setInterval(() => {
                timeLeft--;
                const percentage = (timeLeft / 60) * 100;
                timerBar.style.width = `${percentage}%`;
                
                if (percentage < 66 && percentage >= 33) {
                    timerBar.classList.replace('bg-green-500', 'bg-yellow-500');
                } else if (percentage < 33) {
                    timerBar.classList.replace('bg-yellow-500', 'bg-red-500');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endRound();
                }
            }, 1000);
        }

        function endRound() {
            feedbackElement.textContent = currentPlayer === 'drawer' ? 
                'Tijd voorbij! Wissel van beurt.' ; 
                `Tijd voorbij! Het woord was: ${currentWord}`;
            if (gameMode === 'local') {
                currentPlayer = currentPlayer === 'drawer' ? 'guesser' : 'drawer';
                setTimeout(nextRound, 3000);
            } else {
                socket.emit('endRound', currentTable);
            }
        }

        function updateScore(scoreData) {
            if (scoreData.id === socket.id) {
                score = scoreData.score;
                scoreElement.textContent = `Jouw score: ${score}`;
            } else {
                document.getElementById('opponent-score').textContent = `${opponentName}: ${scoreData.score}`;
            }
        }

        function endRound() {
    feedbackElement.textContent = currentPlayer === 'drawer' 
        ? 'Tijd voorbij! Wissel van beurt.' 
        : `Tijd voorbij! Het woord was: ${currentWord}`;
    if (gameMode === 'local') {
        currentPlayer = currentPlayer === 'drawer' ? 'guesser' : 'drawer';
        setTimeout(nextRound, 3000);
    } else {
        socket.emit('endRound', currentTable);
    }
}

function updateScore(scoreData) {
    if (scoreData.id === socket.id) {
        score = scoreData.score;
        scoreElement.textContent = `Jouw score: ${score}`;
    } else {
        document.getElementById('opponent-score').textContent = `${opponentName}: ${scoreData.score}`;
    }
}

function submitGuess() {
    if (currentPlayer !== 'guesser') return;
    const guess = guessInput.value.toLowerCase();
    if (guess === currentWord) {
        feedbackElement.textContent = 'Goed geraden!';
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 }
        });
        if (gameMode === 'online') {
            socket.emit('correctGuess', { table: currentTable, timeLeft: timeLeft });
        } else {
            endRound();
        }
    } else {
        feedbackElement.textContent = 'Probeer opnieuw!';
    }
    guessInput.value = '';
}

// Drawing functions
function handleStart(e) {
    e.preventDefault();
    if (currentPlayer !== 'drawer') return;
    isDrawing = true;
    [lastX, lastY] = getCoordinates(e);
}

function handleMove(e) {
    e.preventDefault();
    if (!isDrawing || currentPlayer !== 'drawer') return;
    const [x, y] = getCoordinates(e);
    drawLine(lastX, lastY, x, y, currentColor);
    if (gameMode === 'online') {
        socket.emit('draw', { table: currentTable, x1: lastX, y1: lastY, x2: x, y2: y, color: currentColor });
    }
    [lastX, lastY] = [x, y];
}

function handleEnd(e) {
    e.preventDefault();
    isDrawing = false;
}

function getCoordinates(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    if (e.touches && e.touches[0]) {
        return [
            (e.touches[0].clientX - rect.left) * scaleX,
            (e.touches[0].clientY - rect.top) * scaleY
        ];
    }
    return [
        (e.clientX - rect.left) * scaleX,
        (e.clientY - rect.top) * scaleY
    ];
}

function drawLine(x1, y1, x2, y2, color) {
    ctx.beginPath();
    ctx.moveTo(x1, y1);            
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = color;
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    ctx.stroke();
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (gameMode === 'online') {
        socket.emit('clear', currentTable);
    }
}

function resizeCanvas() {
    const container = document.getElementById('canvas-container');
    const containerWidth = container.clientWidth;
    const containerHeight = container.clientHeight;
    
    canvas.width = containerWidth;
    canvas.height = containerHeight;
    
    clearCanvas();
}

// Initialize color palette
colors.forEach(color => {
    const colorOption = document.createElement('div');
    colorOption.className = 'w-8 h-8 rounded-full cursor-pointer transition duration-300 ease-in-out transform hover:scale-110';
    colorOption.style.backgroundColor = color;
    colorOption.addEventListener('click', () => {
        currentColor = color;
        document.querySelectorAll('#color-palette div').forEach(el => el.classList.remove('ring-4'));
        colorOption.classList.add('ring-4', 'ring-purple-500');
    });
    colorPalette.appendChild(colorOption);
});

// Set initial color
document.querySelector('#color-palette div').click();

console.log("Script initialization complete");
    </script>
</body>
</html>
